<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamo Simulation</title>

</head>

<body>

    <div class="chart-container" style="position: relative; height:60vh; width:95vw">
        <canvas id="myChart"></canvas>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.js"></script>
    <script>

        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: "VoltageA",
                    borderColor: "#00F",
                    backgroundColor: "#00F",
                    data: [],
                    pointRadius: 0
                }, {
                    label: "VoltageB",
                    borderColor: "#000077",
                    backgroundColor: "#000077",
                    data: [],
                    pointRadius: 0
                }, {
                    label: "Discharge Current",
                    borderColor: "#FF0000",
                    backgroundColor: "#FF0000",
                    data: [],
                    pointRadius: 0
                }, {
                    label: "Discharge Power",
                    borderColor: "#00AA00",
                    backgroundColor: "#00AA00",
                    data: [],
                    pointRadius: 0
                },
                {
                    label: "Avg Discharge Power",
                    borderColor: "#00FF00",
                    backgroundColor: "#00FF00",
                    data: [],
                    pointRadius: 0
                }],
                labels: []
            },
            options: {
                responsive: true,
                // scales: {
                //     y: {
                //         beginAtZero: true
                //     }
                // },
                animation: {
                    duration: 0, // general animation time
                },
                hover: {
                    animationDuration: 0, // duration of animations when hovering an item
                },
                responsiveAnimationDuration: 0, // animation duration after a resize
            }
        });



        let resistance5v = 6.5;

        let dischargeCurrentA = 0;
        let dischargeCurrentB = 0;



        let capacity = 470e-6;

        function getChargeCurrent(voltage) {
            return (0.2254 * voltage ** 2 - 25.262 * voltage + 611.12) / 1000;
        }

        const drivingSpeedKmh = 25;




        let max_charge = 12.5;
        let min_charge = max_charge -2;

        const initialCapacitorVoltage = max_charge;

        let voltageA = initialCapacitorVoltage;
        let voltageASub = initialCapacitorVoltage;
        let voltageB = initialCapacitorVoltage;
        let voltageBSub = initialCapacitorVoltage;

        let charge_before = null;

        let dutyCycle = 0;

        function executeProgram(va, vb) {
            let charge = null;
            if (va < min_charge || vb < min_charge) {
                dutyCycle = dutyCycle > 0 ? dutyCycle - 1 : 0;
                if (va < vb) {
                    charge = "a";
                } else {
                    charge = "b";
                }
            }
            else if (va > max_charge && vb > max_charge) {
                charge = null;
                dutyCycle = dutyCycle < 100 ? dutyCycle + 1 : 100;
            } else {
                dutyCycle = dutyCycle < 100 ? dutyCycle + 1 : 100;
                // if (va > max_charge) {
                //     charge = "b";
                // } else if (vb > max_charge) {
                //     charge = "a";
                // }
                // else if (charge_before != null) {
                //     charge = charge_before;
                // } else {
                if (va < vb) {
                    charge = "a";
                } else {
                    charge = "b";
                }
                // }
            }

            charge_before = charge;

            console.log(dutyCycle);

            return {
                charge: charge,
                dischargeA: va > 3.5 && charge != "a",
                dischargeB: vb > 3.5 && charge != "b",
                dischargeDutycycle: dutyCycle
            };
        }

        const timestep = 10e-6;

        let time = 0;

        function getEquivalentResistance(voltage) {
            // let input_resistance = time < 2500 * timestep ? 1000 : 8;
            // if (voltage < 8) {
            //     return input_resistance;
            // }
            // let i = 5 / input_resistance;
            // let i_at_v = (i * 5 / voltage) * (1 / 0.77);
            // return voltage / i_at_v;
            return resistance5v;
        }

        let timer1Ctr = 0;
        let timer1InternalCtr = 0;
        let timer1OCR = 1;


        let discharging = false;

        let dischargeA = false;
        let dischargeB = false;

        let dutyperiod = 4;

        function timer1_interrupt(programOutput) {
            if (programOutput.dischargeDutycycle == 100) {
                dischargeA = programOutput.dischargeA;
                dischargeB = programOutput.dischargeB;
                timer1OCR = (timer1Ctr + dutyperiod + Math.round(20 / 8)) % 65535;
            } else if (programOutput.dischargeDutycycle == 0) {
                dischargeA = false;
                dischargeB = false;
                timer1OCR = (timer1Ctr + dutyperiod + Math.round(20 / 8)) % 65535;
            } else {
                discharging = !discharging;
                if (discharging) {
                    if (programOutput.dischargeA) {
                        dischargeA = true;
                    }
                    if (programOutput.dischargeB) {
                        dischargeB = true;
                    }
                    timer1OCR = (timer1Ctr + Math.floor((programOutput.dischargeDutycycle * dutyperiod) / 100) + Math.round(20 / 8)) % 65535;
                }
                else {
                    dischargeA = false;
                    dischargeB = false;
                    timer1OCR = (timer1Ctr + dutyperiod + Math.round(20 / 8)) % 65535;
                }
            }
            console.log(timer1Ctr, timer1OCR);
        }

        function simulateTimeStep(programOutput) {
            time += timestep;
            timer1InternalCtr += timestep;

            if (timer1InternalCtr > (8 / 12e6)) {
                timer1InternalCtr -= (8 / 12e6);
                timer1Ctr = (timer1Ctr + 1) % 65535;
                if (timer1Ctr == timer1OCR) {
                    timer1_interrupt(programOutput);
                    console.log(time, "i");
                }
            }

            if (programOutput.charge == "a") {
                let chargeCurrent = getChargeCurrent(voltageA + voltageASub);
                voltageA += (timestep / capacity) * chargeCurrent;
                voltageASub += (timestep / capacity) * chargeCurrent;
            } else if (programOutput.charge == "b") {
                let chargeCurrent = getChargeCurrent(voltageB + voltageBSub);
                voltageB += (timestep / capacity) * chargeCurrent;
                voltageBSub += (timestep / capacity) * chargeCurrent;
            }
            dischargeCurrentA = 0;
            dischargeCurrentB = 0;
            if (dischargeA) {
                let r = getEquivalentResistance(voltageA);
                let discharge = Math.exp(-1 * timestep / ((r * 2) * (capacity)));
                dischargeCurrentA += 2 * (voltageA * discharge / (2 * r));
                voltageA = voltageA * discharge;
                voltageASub = voltageASub * discharge;
            }
            if (dischargeB) {
                let r = getEquivalentResistance(voltageB);
                let discharge = Math.exp(-1 * timestep / ((r * 2) * (capacity)));
                dischargeCurrentB += 2 * (voltageA * discharge / (2 * r));
                voltageB = voltageB * discharge;
                voltageBSub = voltageBSub * discharge;
            }
        }

        let programRunTime = 200e-6;


        let avgPowerUs = 10000e-6;



        let avgPowerDataPoints = avgPowerUs / timestep;

        function updateChart(programOutput) {

            myChart.data.datasets[0].data.push(voltageA);
            myChart.data.datasets[1].data.push(voltageB);
            myChart.data.datasets[2].data.push(dischargeCurrentA + dischargeCurrentB);
            myChart.data.datasets[3].data.push((dischargeCurrentA * voltageA) + (dischargeCurrentB * voltageB));
            let avgPower = 0;
            if (myChart.data.datasets[3].data.length > avgPowerDataPoints) {
                avgPower = myChart.data.datasets[3].data.slice(-avgPowerDataPoints).reduce((a, b) => a + b, 0) / avgPowerDataPoints;
            }
            myChart.data.datasets[4].data.push(avgPower);
            // myChart.data.datasets[3].data.push(voltageBSub);

            var length = myChart.data.labels.length;
            // for (let d of myChart.data.datasets) {
            //     d.data = d.data.slice(Math.max(0, length - 500 + 1));
            // }

            myChart.data.labels.push(`${Math.round(time * 1e6)}us`);
            // myChart.data.labels = myChart.data.labels.slice(Math.max(0, length - 500 + 1));

        }

        for (let i = 0; i < 400; i++) {
            let output = executeProgram(voltageASub, voltageBSub);
            for (let j = 0; j < programRunTime / timestep; j++) {
                simulateTimeStep(output);
                updateChart(output);
            }
        }

        myChart.update();








    </script>
</body>

</html>